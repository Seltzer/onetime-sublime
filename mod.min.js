!function(e){function t(t,n,a,i,o){function s(){var t=n.viewedMonth.month();a.find(r).each(function(){var n=e(this),a=i.data[n.index()];if(!a)return!0;var s=a.weekDateTime;n.data("date",s);var d=o||s.getMonth()===t;n.toggleClass("clickable",d),n.toggleClass("non-clickable",!d)})}t.bind("navigate",s),a.bind("dataBound",s),s(),a.delegate(r,"click",function(){var a=e(this),i=a.data("date");a.hasClass("clickable")&&ots.core.oneTime.selectDayInCalendar(t,n,i,o)})}function n(e,t,n){function a(){if(ots.core.oneTime.calendarIsInStandardMode(t)){var n=ots.core.oneTime.getDayInDisplayedCalendar(e,t,ots.core.dates.getDateNow());e.find(".t-content tbody tr td.today").not(n?n.$td:[]).removeClass("today"),n&&n.$td.addClass("today")}}e.bind("navigate change",a),n.bind("dataBound",a),a()}function a(t){function n(){return t.find(".t-content.t-state-active .t-grid-content table tbody tr")}function a(){var t=o.val().trim();n().each(function(){var n=e(this);n.toggle(!t||ots.core.containsSubstring(n.text(),t))})}var i=e('<li class="favourites-filter"></li>').appendTo(t.find("ul.t-tabstrip-items")),o=e('<input type="search" placeholder="Type here to filter" />').appendTo(i).bind("keyup mouseout mousedown search",a);ots.core.oneTime.onFavTabSelected(t,function(t){var n=e(t.item).text();i.toggle(ots.core.containsSubstring(n,"personal")||ots.core.containsSubstring(n,"team")),o.val(""),a()})}function i(e,t,n,a){function i(){function n(e){e.weekOfTimesheets.isIncomplete?_.chain(e.$dayTds).zip(e.weekOfTimesheets.days).map(function(e){return{date:e[1].date,isIncomplete:e[1].isIncomplete,$td:e[0]}}).filter(function(e){return a||e.date<d}).each(function(e){e.$td.toggleClass("incomplete",e.isIncomplete)}).value():_.each(e.$dayTds,function(e){e.removeClass("incomplete")})}if(ots.core.oneTime.calendarIsInStandardMode(t)){var i=ots.core.oneTime.getWeeksInDisplayedCalendar(e,t),o=_.first(i)[0].date,s=_.last(i)[0].date,d=ots.core.dates.zeroDate(ots.core.dates.addDays(ots.core.dates.getDateNow(),1));ots.core.oneTime.getWeeksOfTimesheets(o,s).done(function(e){_.chain(i).zip(e).map(function(e){return{weekOfTimesheets:e[1],$dayTds:_.map(e[0],"$td")}}).each(n)})}}e.bind("navigate",i),n.bind("dataBound",i),i()}function o(t,n){function a(){t.find("table tbody tr td > a.t-action-link").each(function(){e(this).parent().addClass("public-holiday")})}t.bind("change navigate",a),n.bind("dataBound",a),a()}function s(t){var n=e("#titleContainer");n.find("#headingText").parent().contents().filter(function(){return 3===this.nodeType&&e(this).nextAll("#headingText").length}).remove(),n.find("#helpFileBtn, ul.t-widget > li").width(97);var a=_.template('{{ _.each(data, function (item) { }}<li {{ if (item.explanation) { }} class="no-bullet" {{ } }}>{{ if (item.explanation) { }}<details><summary> {{= item.description }}</summary>{{= item.explanation }}</details>{{ } else { }}{{= item.description }}{{ } }}</li>{{ }) }}',{variable:"data"}),i=_.template('<div class="whats-new-dialog"><h2>What\'s new in v2?</h2><h3>Enhancements</h3><ul>{{= listItemsTemplate(enhancements) }}</ul><h3>Bugfixes</h3><ul>{{= listItemsTemplate(bugfixes) }}</ul><div class="dismiss"><a href="javascript:void(0)">Dismiss</a><div class="ots-clear"></div></div></div>'),o=i({enhancements:[{description:"Added 'Find incomplete day' button.",explanation:"Allows you to cycle through incomplete days from the past few months and (optionally) from the upcoming month."},{description:"Added option to allow week grid clicking to trigger a month change.",explanation:"Enabled by default."},{description:"Added option to allow text to wrap in tables.",explanation:"Disabled by default."}],bugfixes:[{description:"Fixed bug where multiple calendar days would be highlighted as 'Today' when OneTime was left open overnight."},{description:"Fixed bug where days near the end of the month would never be marked as incomplete."},{description:"Fixed calendar highlighting bugs."},{description:"Fixed miscellaneous timing bugs."},{description:"Fixed errors triggered by changing calendar view type."}],listItemsTemplate:a}),s=e(o).appendTo(e("#main")).hide().find(".dismiss a").click(e.unblockUI).end();e('<span id="ots-header"><span id="modded-with">Modded with </span>OneTime Sublime v2.5 <span class="links">( <a href="'+t+'" target="_blank">options</a> / <a href="https://github.com/Seltzer/onetime-sublime" target="_blank">docs</a> / <a href="javascript:void(0);" class="whats-new">what\'s new</a> )</span></span>').appendTo(n).find(".whats-new").click(function(){ots.core.analytics.record("whats-new"),e.blockUI({message:s,css:{cursor:"default",textAlign:"left",top:"20%"},overlayCSS:{cursor:"default"}}),e(".blockOverlay").attr("title","Click to return to OneTime").click(e.unblockUI)})}function d(t){var n=e("html");n.attr({"data-today-highlighting-enabled":t.enableTodayHighlighting,"data-incomplete-day-highlighting-enabled":t.enableIncompleteDayHighlighting})}function l(t,n){function a(){o(t.find(".t-content.t-state-active table"))}function i(){o(n.find(".t-grid-content table"))}function o(t){t.find("tbody tr td").each(function(){e(this).css("white-space","normal")})}ots.core.oneTime.onFavTabSelected(t,function(t){var n=e(t.item).text();(ots.core.containsSubstring(n,"personal")||ots.core.containsSubstring(n,"team"))&&a()}),n.bind("dataBound",i),a(),i()}function c(t,n,a){function i(){var t=ots.core.dates.zeroDate(ots.core.dates.getDateNow()),n=ots.core.dates.addMonths(t,-3),i=a?ots.core.dates.addMonths(t,1):t,o=ots.core.dates.getWeekStart(n),s=ots.core.dates.getWeekStart(i);return ots.core.oneTime.getWeeksOfTimesheets(o,s).pipe(function(t){var a=_.chain(t).map(function(e){return e.days}).flatten().filter(function(e){return e.date>=n&&e.date<=i}).value(),o=_.findIndex(a,function(e){return e.hours>0});if(-1!==o&&(a=_.rest(a,o)),d=_.filter(a,function(e){return e.isIncomplete}),c){var s=_.findIndex(d,function(e){return e.date>=c});if(-1!==s)return l=s,c=d[s].date,e.Deferred().resolve()}return l=0,c=d.length?d[l].date:null,e.Deferred().resolve()})}function o(){ots.core.oneTime.selectDayInCalendar(t,n,d[l].date,!0),l=(l+1)%d.length,c=d[l].date}var s=0,d=null,l=null,c=null;i(),e("#saveBtn, #copyTimesheetBtn span, #deleteTimesheetBtn span").click(function(){d=null}),e('<button id="find-incomplete-day" class="button">Find incomplete day</button>').insertAfter(e("#today")).click(function(){(++s<3||s%10===0)&&ots.core.analytics.record("find-incomplete",{n:s}),null===d?i().done(function(){d.length&&o()}):d.length&&o()})}var r="table:eq(1) > tbody > tr";e(function(){var r=e("#ots-config").data("ots-config");_.templateSettings={evaluate:/\{\{(.+?)\}\}/g,interpolate:/\{\{=(.+?)\}\}/g,escape:/\{\{-(.+?)\}\}/g},s(r.optionsUrl),ots.core.analytics.initialise();var u=e("#cal"),h=u.data("tCalendar"),g=e("#weekgrid"),f=g.data("tGrid"),m=e("#favTab"),p=e("#timesheetgrid");d(r),h.stopAnimation=!0,r.enableFavouritesFiltering&&a(m),(r.enableIncompleteDayHighlighting||r.enableTodayHighlighting)&&(o(u,g),r.enableIncompleteDayHighlighting&&i(u,h,g,r.includeFutureDays),r.enableTodayHighlighting&&n(u,h,g)),r.enableWeekGridClicking&&t(u,h,g,f,r.allowMonthChange),r.enableTableTextWrapping&&l(m,p),r.enableFindIncompleteButton&&c(u,h,r.includeFutureDays)})}(jQuery);
