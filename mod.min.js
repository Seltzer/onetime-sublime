!function(e){function t(t,n,a,i){function o(){var t=n.viewedMonth.month();a.find(d).each(function(){var n=e(this),a=i.data[n.index()];if(!a)return!0;var o=a.weekDateTime;n.data("date",o).toggleClass("another-month",o.getMonth()!==t)})}t.bind("navigate ots-cal-change",o),a.bind("dataBound",o),o()}function n(t){function n(){return t.find(".t-content.t-state-active .t-grid-content table tbody tr")}function a(){var t=o.val().trim();n().each(function(){var n=e(this);n.toggle(!t||ots.core.containsSubstring(n.text(),t))})}var i=e('<li class="favourites-filter"></li>').appendTo(t.find("ul.t-tabstrip-items")),o=e('<input type="search" placeholder="Type here to filter" />').appendTo(i).bind("keyup mouseout mousedown search",a);ots.core.oneTime.onFavTabSelected(t,function(t){var n=e(t.item).text();i.toggle(ots.core.containsSubstring(n,"personal")||ots.core.containsSubstring(n,"team")),o.val(""),a()})}function a(t,n,a,i,o){function s(){var e=ots.core.dates.zeroDate(ots.core.dates.addDays(ots.core.dates.getDateNow(),1));l(e),r(e)}function l(t){if(i.data&&i.data.length){var n=i.data[0].weekDateTime;ots.core.oneTime.getWeeksOfTimesheets(n,n).done(function(n){var i=n[0].days,s=a.find(d);_.chain(i).zip(s).map(function(t){return{day:t[0],$tr:e(t[1])}}).filter(function(e){return o||e.day.date<t}).each(function(e){c(e.$tr,e.day)})})}}function r(e){function a(t){_.chain(t.$dayTds).zip(t.weekOfTimesheets.days).map(function(e){return{$td:e[0],day:e[1]}}).filter(function(t){return o||t.day.date<e}).each(function(e){c(e.$td,e.day)}).value()}if(ots.core.oneTime.calendarIsInStandardMode(n)){var i=ots.core.oneTime.getWeeksInDisplayedCalendar(t,n),s=_.first(i)[0].date,l=_.last(i)[0].date;ots.core.oneTime.getWeeksOfTimesheets(s,l).done(function(e){_.chain(i).zip(e).map(function(e){return{$dayTds:_.map(e[0],"$td"),weekOfTimesheets:e[1]}}).each(a)})}}function c(e,t){e.toggleClass("blank",!t.isPublicHoliday&&t.completeness===ots.core.TimesheetCompleteness.Blank).toggleClass("partially-complete",!t.isPublicHoliday&&t.completeness===ots.core.TimesheetCompleteness.PartiallyComplete).toggleClass("complete",!t.isPublicHoliday&&t.completeness===ots.core.TimesheetCompleteness.Complete).toggleClass("exceeded",!t.isPublicHoliday&&t.completeness===ots.core.TimesheetCompleteness.Exceeded).toggleClass("public-holiday",t.isPublicHoliday)}t.bind("navigate ots-cal-change",s),a.bind("dataBound",s),s()}function i(t){var n=e("#titleContainer");n.find("#headingText").parent().contents().filter(function(){return 3===this.nodeType&&e(this).nextAll("#headingText").length}).remove(),n.find("#helpFileBtn, ul.t-widget > li").width(97);var a=_.template('{{ _.each(data, function (item) { }}<li {{ if (item.explanation) { }} class="no-bullet" {{ } }}>{{ if (item.explanation) { }}<details><summary> {{= item.description }}</summary>{{= item.explanation }}</details>{{ } else { }}{{= item.description }}{{ } }}</li>{{ }) }}',{variable:"data"}),i=_.template('<div class="whats-new-dialog"><h2>What\'s new?</h2><h3>Enhancements</h3><ul>{{= listItemsTemplate(enhancements) }}</ul><h3>Bugfixes</h3><ul>{{= listItemsTemplate(bugfixes) }}</ul><a href="https://github.com/Seltzer/onetime-sublime/blob/master/CHANGELOG.md" target="_blank">Full changelog</a><div class="dismiss"><a href="javascript:void(0)">Dismiss</a><div class="ots-clear"></div></div></div>'),o=i({enhancements:[{description:"Added / modified / removed many features across the board.",explanation:"Required, in order to accommodate the new major release of OneTime which assimilates various OTS features."},{description:"Added 'Find incomplete day' button.",explanation:"Allows you to cycle through incomplete days from the past few months and (optionally) from the upcoming month."},{description:"Added option to allow week grid clicking to trigger a month change.",explanation:"Enabled by default."},{description:"Added option to allow text to wrap in tables.",explanation:"Disabled by default."},{description:"Improved incomplete day highlighting and Today higlighting.",explanation:"Partially complete days and over-saturated days are now highlighted differently to blank / complete days respectively. Week grid is now highlighted. Today is now highlighted using large font, rather than a green rectangle."}],bugfixes:[{description:"Fixed bug where multiple calendar days would be highlighted as 'Today' when OneTime was left open overnight."},{description:"Fixed bug where days near the end of the month would never be marked as incomplete."},{description:"Fixed calendar highlighting bugs."},{description:"Fixed miscellaneous timing bugs."},{description:"Fixed errors triggered by changing calendar view type."}],listItemsTemplate:a}),s=e(o).appendTo(e("#main")).hide().find(".dismiss a").click(e.unblockUI).end();e('<span id="ots-header"><span id="modded-with">Modded with </span>OneTime Sublime v3.0 <span class="links">( <a href="'+t+'" target="_blank">options</a> / <a href="https://github.com/Seltzer/onetime-sublime" target="_blank">docs</a> / <a href="javascript:void(0);" class="whats-new">what\'s new</a> )</span></span>').appendTo(n).find(".whats-new").click(function(){ots.core.analytics.record("whats-new"),e.blockUI({message:s,css:{cursor:"default",textAlign:"left",top:"20%"},overlayCSS:{cursor:"default"}}),e(".blockOverlay").attr("title","Click to return to OneTime").click(e.unblockUI)})}function o(t){var n=e("html");n.attr({"data-incomplete-day-highlighting-enabled":t.enableIncompleteDayHighlighting})}function s(t,n){function a(){o(t.find(".t-content.t-state-active table"))}function i(){o(n.find(".t-grid-content table"))}function o(t){t.find("tbody tr td").each(function(){e(this).css("white-space","normal")})}ots.core.oneTime.onFavTabSelected(t,function(t){var n=e(t.item).text();(ots.core.containsSubstring(n,"personal")||ots.core.containsSubstring(n,"team"))&&a()}),n.bind("dataBound",i),a(),i()}function l(t,n,a){function i(){var t=ots.core.dates.zeroDate(ots.core.dates.getDateNow()),n=ots.core.dates.addMonths(t,-3),i=a?ots.core.dates.addMonths(t,1):t,o=ots.core.dates.getWeekStart(n),s=ots.core.dates.getWeekStart(i);return ots.core.oneTime.getWeeksOfTimesheets(o,s).pipe(function(t){var a=_.chain(t).map(function(e){return e.days}).flatten().filter(function(e){return e.date>=n&&e.date<=i}).value(),o=_.findIndex(a,function(e){return e.hours>0});if(-1!==o&&(a=_.rest(a,o)),l=_.filter(a,function(e){return e.completeness===ots.core.TimesheetCompleteness.Blank||e.completeness===ots.core.TimesheetCompleteness.PartiallyComplete}),r){var s=_.findIndex(l,function(e){return e.date>=r});if(-1!==s)return d=s,r=l[s].date,e.Deferred().resolve()}return d=0,r=l.length?l[d].date:null,e.Deferred().resolve()})}function o(){ots.core.oneTime.selectDayInCalendar(t,n,l[d].date,!0),d=(d+1)%l.length,r=l[d].date}var s=0,l=null,d=null,r=null;i(),e("#saveBtn, #copyTimesheetBtn span, #deleteTimesheetBtn span").click(function(){l=null}),e('<button id="find-incomplete-day" class="button">Find incomplete day</button>').insertAfter(e("#today")).click(function(){(++s<3||s%10===0)&&ots.core.analytics.record("find-incomplete",{n:s}),null===l?i().done(function(){l.length&&o()}):l.length&&o()})}var d="table:eq(1) > tbody > tr";e(function(){var d=e("#ots-config").data("ots-config");_.templateSettings={evaluate:/\{\{(.+?)\}\}/g,interpolate:/\{\{=(.+?)\}\}/g,escape:/\{\{-(.+?)\}\}/g},i(d.optionsUrl);var r=e("#cal"),c=r.data("tCalendar"),u=e("#weekgrid"),h=u.data("tGrid"),m=e("#favTab"),g=e("#timesheetgrid");o(d),c.stopAnimation=!0;var p=window.HighlightIncompleteDaysForCal;window.HighlightIncompleteDaysForCal=function(){p(),r.trigger("ots-cal-change")},d.enableFavouritesFiltering&&n(m),d.enableIncompleteDayHighlighting&&a(r,c,u,h,d.includeFutureDays),d.enableTableTextWrapping&&s(m,g),d.enableFindIncompleteButton&&l(r,c,d.includeFutureDays),t(r,c,u,h)})}(jQuery);
